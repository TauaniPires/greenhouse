{% extends 'base.html' %} {% block content %}
<div class="row g-4">
  <div class="col-lg-8">
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-white">
        <h4 class="mb-0">Status Atual</h4>
      </div>
      <div class="card-body">
        <div class="row text-center">
          <div class="col-md-4">
            <div class="p-3">
              <i class="bi bi-thermometer-sun fs-1 text-danger"></i>
              <h2 class="mt-2"><span id="temp-display">--</span>°C</h2>
              <p class="text-muted mb-0">Temperatura</p>
            </div>
          </div>
          <div class="col-md-4">
            <div class="p-3">
              <i class="bi bi-droplet-half fs-1 text-primary"></i>
              <h2 class="mt-2"><span id="humidity-display">--</span>%</h2>
              <p class="text-muted mb-0">Umidade</p>
            </div>
          </div>
          <div class="col-md-4">
            <div class="p-3 status-card" id="curtain-status-card">
              <i id="curtain-icon" class="fs-1"></i>
              <h4 class="mt-2" id="curtain-status-text">--</h4>
              <p class="text-muted mb-0">Status da Cortina</p>
            </div>
          </div>
        </div>
        <div class="text-center text-muted mt-3">
          <small
            >Última atualização: <span id="last-update">--:--:--</span></small
          >
        </div>

        <div class="mt-4 px-3">
          <a href="/historico" class="botao-historico">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="2"
              stroke="currentColor"
              class="icone"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z"
              />
            </svg>
            <span>Ver histórico</span>
          </a>

          <style>
            .botao-historico {
              display: flex; /* Garante que o item seja um bloco flexível */
              justify-content: center; /* Centraliza o ícone e o texto */
              width: 100%; /* Faz o botão ocupar 100% da largura do container */
              align-items: center;
              gap: 0.5rem;
              background: linear-gradient(90deg, #4caf50, #81c784);
              color: white;
              font-weight: 600;
              padding: 0.75rem 1.25rem;
              border-radius: 12px;
              text-decoration: none;
              box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
              transition: transform 0.2s ease, box-shadow 0.2s ease;
            }

            .botao-historico:hover {
              transform: translateY(-2px);
              box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
            }

            .icone {
              width: 24px;
              height: 24px;
            }
            #params-form:has(input:disabled) {
              opacity: 0.6;
              pointer-events: none;
            }
          </style>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-white">
        <h5 class="mb-0">Definir Parâmetros</h5>
      </div>
      <div class="card-body">
        <form id="params-form">
          {% csrf_token %}
          <label for="min-temp" class="form-label"
            >Temperatura Mínima (°C)</label
          >
          <input
            type="number"
            step="0.5"
            class="form-control mb-2"
            id="min-temp"
            value="{{ control.min_temperature }}"
          />

          <label for="max-temp" class="form-label"
            >Temperatura Máxima (°C)</label
          >
          <div class="input-group mb-3">
            <input
              type="number"
              step="0.5"
              class="form-control"
              id="max-temp"
              value="{{ control.max_temperature }}"
            />
            <button class="btn btn-outline-success" type="submit">
              Salvar
            </button>
          </div>
        </form>
      </div>
    </div>
    <div class="form-check form-switch text-start mb-3">
      <input
        class="form-check-input"
        type="checkbox"
        id="auto-switch"
        {%
        if
        control.automatic_mode
        %}checked{%
        endif
        %}
        onchange="toggleAutomaticMode(this.checked)"
        onchange="toggleAutomaticMode(this.checked)"
      />
      <label class="form-check-label" for="autoModeSwitch">
        Modo Automático
      </label>
    </div>

    <div class="card shadow-sm">
      <div class="card-header bg-white">
        <h5 class="mb-0">Controle Manual</h5>
      </div>
      <div class="card-body text-center">
        <div class="btn-group w-100">
          <button
            id="btn-open"
            class="btn btn-primary btn-lg"
            onclick="manualControl('open')"
          >
            <i class="bi bi-arrow-up-circle"></i> Abrir
          </button>
          <button
            id="btn-close"
            class="btn btn-warning btn-lg"
            onclick="manualControl('close')"
          >
            <i class="bi bi-arrow-down-circle"></i> Fechar
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<div
  id="toast-container"
  class="toast-container position-fixed bottom-0 end-0 p-3"
></div>
{% endblock %} {% block scripts %}
<script>
  const csrfToken = document.querySelector("[name=csrfmiddlewaretoken]").value;

  function updateStatus() {
    fetch("{% url 'api_status' %}")
      .then((response) => response.json())
      .then((data) => {
        const latest = data.latest_reading;
        if (latest) {
          document.getElementById("temp-display").textContent =
            latest.temperature.toFixed(1);
          document.getElementById("humidity-display").textContent =
            latest.humidity.toFixed(1);
          document.getElementById("last-update").textContent = new Date(
            latest.timestamp
          ).toLocaleTimeString();
        }

        const statusCard = document.getElementById("curtain-status-card");
        const statusText = document.getElementById("curtain-status-text");
        const statusIcon = document.getElementById("curtain-icon");

        if (data.curtain_is_open) {
          statusText.textContent = "Aberta";
          statusIcon.className = "bi bi-unlock-fill fs-1 text-primary";
          statusCard.classList.remove("closed");
          statusCard.classList.add("open");
        } else {
          statusText.textContent = "Fechada";
          statusIcon.className = "bi bi-lock-fill fs-1 text-warning";
          statusCard.classList.remove("open");
          statusCard.classList.add("closed");
        }
      })
      .catch((error) => console.error("Erro ao buscar status:", error));
  }

  document
    .getElementById("params-form")
    .addEventListener("submit", function (e) {
      e.preventDefault();
      const minTemp = parseFloat(document.getElementById("min-temp").value);
      const maxTemp = parseFloat(document.getElementById("max-temp").value);

      fetch("{% url 'api_set_parameters' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrfToken,
        },
        body: JSON.stringify({
          min_temperature: minTemp,
          max_temperature: maxTemp,
        }),
      })
        .then((response) => response.json())
        .then((data) => {
          showToast(
            data.success ? "Parâmetros salvos!" : "Erro ao salvar",
            data.success ? "success" : "danger"
          );
          updateStatus(); // Atualiza o dashboard imediatamente
          updateManualButtonsState();
          setInterval(updateStatus, 5000);
        });
    });
  function toggleAutomaticMode(isAutomatic) {
    fetch("{% url 'toggle_automatic_mode' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": csrfToken,
      },
      body: JSON.stringify({ automatic_mode: isAutomatic }),
    })
      .then((response) => response.json())
      .then((data) => {
        showToast(
          data.automatic_mode
            ? "Modo automático ativado"
            : "Modo manual ativado",
          "success"
        );
        updateInterfaceState(); // <-- Atualiza tudo com uma única função
      })
      .catch(() => showToast("Erro ao alternar o modo", "danger"));
  }

  // Atualiza os estados dos botões e campos de parâmetros
  function updateInterfaceState() {
    const isAuto = document.getElementById("auto-switch").checked;

    // Botões de controle manual ficam desativados no modo automático
    document.getElementById("btn-open").disabled = isAuto;
    document.getElementById("btn-close").disabled = isAuto;

    // Campos de parâmetros ficam desativados no modo manual
    document.getElementById("min-temp").disabled = !isAuto;
    document.getElementById("max-temp").disabled = !isAuto;
    document.querySelector("#params-form button").disabled = !isAuto;
  }

  // Atualiza o estado inicial ao carregar a página
  document.addEventListener("DOMContentLoaded", () => {
    fetch("{% url 'api_status' %}")
      .then((res) => res.json())
      .then((data) => {
        const autoSwitch = document.getElementById("auto-switch");
        autoSwitch.checked = data.automatic_mode; // garante que checkbox reflete o banco
        updateInterfaceState(); // atualiza botões e campos
      })
      .catch((err) => console.error("Erro ao buscar estado automático:", err));
  });

  function updateManualButtonsState() {
    const isAuto = document.getElementById("auto-switch").checked;
    document.getElementById("btn-open").disabled = isAuto;
    document.getElementById("btn-close").disabled = isAuto;
  }

  function manualControl(action) {
    fetch("{% url 'api_manual_control' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": csrfToken,
      },
      body: JSON.stringify({ action: action }),
    })
      .then((response) => response.json())
      .then((data) => {
        showToast(
          data.success ? "Ação realizada!" : "Erro na ação",
          data.success ? "success" : "danger"
        );
        updateStatus(); // Atualiza o dashboard imediatamente
      });
  }

  function showToast(message, type = "success") {
    const toastContainer = document.getElementById("toast-container");
    const toastEl = document.createElement("div");
    toastEl.className = `toast align-items-center text-bg-${type} border-0`;
    toastEl.setAttribute("role", "alert");
    toastEl.setAttribute("aria-live", "assertive");
    toastEl.setAttribute("aria-atomic", "true");
    toastEl.innerHTML = `
      <div class="d-flex">
        <div class="toast-body">${message}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    `;
    toastContainer.appendChild(toastEl);
    const toast = new bootstrap.Toast(toastEl);
    toast.show();
  }

  // Atualização automática a cada 5 segundos
  updateStatus();
  setInterval(updateStatus, 5000);
</script>
{% endblock %}
