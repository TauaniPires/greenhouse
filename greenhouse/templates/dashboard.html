{% extends 'base.html' %} {% block content %}
<div class="row g-4">
  <!-- COLUNA PRINCIPAL (esquerda) -->
  <div class="col-lg-8">
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-white border-0 d-flex align-items-center">
        <h4 class="mb-0">
          <i class="bi bi-speedometer2 me-2"></i>Status Atual
        </h4>
      </div>

      <div class="card-body">
        <!-- linha dos trÃªs cards: temperatura, umidade, safety -->
        <div class="row text-center">
          <div class="col-md-4 mb-3">
            <div class="p-3">
              <i class="bi bi-thermometer-sun fs-1 text-temperatura"></i>
              <h2 class="mt-2 fw-semibold text-dark">
                <span id="temp-display">--</span>Â°C
              </h2>
              <p class="text-muted mb-0">Temperatura</p>
            </div>
          </div>

          <div class="col-md-4 mb-3">
            <div class="p-3">
              <i class="bi bi-droplet-half fs-1 text-umidade"></i>
              <h2 class="mt-2 fw-semibold text-dark">
                <span id="humidity-display">--</span>%
              </h2>
              <p class="text-muted mb-0">Umidade</p>
            </div>
          </div>

          <!-- CARTÃƒO DE SEGURANÃ‡A (safety) -->
          <div class="col-md-4 mb-3">
            <div class="p-3 status-card rounded-3" id="safety-card">
              <i id="safety-icon" class="fs-1 text-aviso"></i>
              <h4 class="mt-2 fw-semibold" id="safety-status-text">--</h4>
              <p
                id="safety-last-contact"
                class="text-secondary mt-1"
                style="font-size: 0.9rem"
              >
                Ãšltimo contato: --
              </p>
              <p
                id="safety-esp-ip"
                class="text-secondary mt-1"
                style="font-size: 0.9rem"
              >
                IP do ESP: --
              </p>
            </div>
          </div>
        </div>

        <!-- * AQUI: cartÃµes das cortinas (ficam abaixo do status, lado a lado) * -->
        <div class="row mt-4 g-3">
          <div class="col-md-6">
            <div class="card p-3" id="left-card">
              <h5 class="text-center">Cortina â€” Esquerda</h5>
              <div class="text-center my-3">
                <i id="left-icon" class="bi bi-lock-fill fs-1 text-aviso"></i>
                <h6 id="left-status-text" class="mt-2">--</h6>
                <p id="left-movement-text" class="text-secondary">--</p>
              </div>
            </div>
          </div>

          <div class="col-md-6">
            <div class="card p-3" id="right-card">
              <h5 class="text-center">Cortina â€” Direita</h5>
              <div class="text-center my-3">
                <i id="right-icon" class="bi bi-lock-fill fs-1 text-aviso"></i>
                <h6 id="right-status-text" class="mt-2">--</h6>
                <p id="right-movement-text" class="text-secondary">--</p>
              </div>
            </div>
          </div>
        </div>

        <!-- rodapÃ© do card grande -->
        <div class="mt-4 text-center text-muted">
          <small
            >Ãšltima atualizaÃ§Ã£o: <span id="footer-last-update">--</span></small
          >
        </div>
        <div class="text-center mt-3">
          <a
            href="{% url 'historico' %}"
            class="btn btn-success px-4"
            style="font-weight: 600"
          >
            <i class="bi bi-graph-up"></i> Ver HistÃ³rico
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- COLUNA DIREITA (parÃ¢metros + controles manuais) -->
  <div class="col-lg-4">
    <!-- ParÃ¢metros -->
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-white">
        <h5 class="mb-0">Definir ParÃ¢metros</h5>
      </div>
      <div class="card-body">
        <form id="params-form">
          {% csrf_token %}
          <label for="min-temp" class="form-label"
            >Temperatura MÃ­nima (Â°C)</label
          >
          <input
            type="number"
            step="0.5"
            class="form-control mb-2"
            id="min-temp"
            value="{{ control.min_temperature }}"
          />

          <label for="max-temp" class="form-label"
            >Temperatura MÃ¡xima (Â°C)</label
          >
          <div class="input-group mb-3">
            <input
              type="number"
              step="0.5"
              class="form-control"
              id="max-temp"
              value="{{ control.max_temperature }}"
            />
            <button class="btn btn-outline-success" type="submit">
              Salvar
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Toggle automÃ¡tico -->
    <div class="form-check form-switch text-start mb-3">
      <input
        class="form-check-input"
        type="checkbox"
        id="auto-switch"
        {%
        if
        control.automatic_mode
        %}checked{%
        endif
        %}
        onchange="toggleAutomaticMode(this.checked)"
      />
      <label class="form-check-label" for="autoModeSwitch"
        >Modo AutomÃ¡tico</label
      >
    </div>

    <!-- Controle Manual â€” Esquerda -->
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-white">
        <h5 class="mb-0">Controle Manual â€” Cortina Esquerda</h5>
      </div>
      <div class="card-body text-center">
        <div class="btn-group w-100">
          <button
            id="left-open"
            type="button"
            class="btn btn-success btn-lg"
            onclick="manualLeft('open')"
          >
            <i class="bi bi-arrow-up-circle"></i> Abrir
          </button>
          <button
            id="left-stop"
            type="button"
            class="btn btn-warning btn-lg"
            onclick="manualLeft('stop')"
          >
            <i class="bi bi-pause-circle"></i> Parar
          </button>
          <button
            id="left-close"
            type="button"
            class="btn btn-danger btn-lg"
            onclick="manualLeft('close')"
          >
            <i class="bi bi-arrow-down-circle"></i> Fechar
          </button>
        </div>
      </div>
    </div>

    <!-- Controle Manual â€” Direita -->
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-white">
        <h5 class="mb-0">Controle Manual â€” Cortina Direita</h5>
      </div>
      <div class="card-body text-center">
        <div class="btn-group w-100">
          <button
            id="right-open"
            type="button"
            class="btn btn-success btn-lg"
            onclick="manualRight('open')"
          >
            <i class="bi bi-arrow-up-circle"></i> Abrir
          </button>
          <button
            id="right-stop"
            type="button"
            class="btn btn-warning btn-lg"
            onclick="manualRight('stop')"
          >
            <i class="bi bi-pause-circle"></i> Parar
          </button>
          <button
            id="right-close"
            type="button"
            class="btn btn-danger btn-lg"
            onclick="manualRight('close')"
          >
            <i class="bi bi-arrow-down-circle"></i> Fechar
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<div
  id="toast-container"
  class="toast-container position-fixed bottom-0 end-0 p-3"
></div>
{% endblock %} {% block scripts %}
<script>
  const csrfToken = document.querySelector("[name=csrfmiddlewaretoken]")
    ? document.querySelector("[name=csrfmiddlewaretoken]").value
    : "";

  // desabilita/ativa todos botÃµes manuais
  function disableManualButtons(disabled) {
    const ids = [
      "left-open",
      "left-stop",
      "left-close",
      "right-open",
      "right-stop",
      "right-close",
    ];
    ids.forEach((id) => {
      const b = document.getElementById(id);
      if (b) b.disabled = disabled;
    });
  }

  // atualiza interface (dependendo do modo automÃ¡tico e do estado do ESP)
  function updateInterfaceStateFromData(data) {
    const isAuto = Boolean(data.automatic_mode);
    const espOnline = Boolean(data.esp_online);
    const autoSwitch = document.getElementById("auto-switch");

    // mantÃ©m o switch sincronizado com o backend
    if (autoSwitch) {
      autoSwitch.checked = isAuto;
    }

    // se ESP offline -> tudo desativado
    if (!espOnline) {
      disableManualButtons(true);
      document.getElementById("min-temp").disabled = true;
      document.getElementById("max-temp").disabled = true;
      document.querySelector("#params-form button").disabled = true;
      if (autoSwitch) {
        autoSwitch.disabled = true;
      }
      return;
    }

    // ESP online -> garante que o switch esteja habilitado
    if (autoSwitch) {
      autoSwitch.disabled = false;
    }

    // se automÃ¡tico -> desativa manuais e habilita parÃ¢metros
    if (isAuto) {
      disableManualButtons(true);
      document.getElementById("min-temp").disabled = false;
      document.getElementById("max-temp").disabled = false;
      document.querySelector("#params-form button").disabled = false;
    } else {
      // manual -> habilita controles manuais e desabilita parÃ¢metros
      disableManualButtons(false);
      document.getElementById("min-temp").disabled = true;
      document.getElementById("max-temp").disabled = true;
      document.querySelector("#params-form button").disabled = true;
    }
  }

  // funÃ§Ã£o principal que busca status e atualiza UI
  function updateStatus() {
    fetch("{% url 'get_status_api' %}?device=browser")
      .then((response) => response.json())
      .then((data) => {
        // sensor display
        if (data.latest_reading) {
          document.getElementById("temp-display").textContent =
            data.latest_reading.temperature.toFixed(1);
          document.getElementById("humidity-display").textContent =
            data.latest_reading.humidity.toFixed(1);

          const dt = new Date(data.latest_reading.timestamp);
          const footerLastUpdate =
            document.getElementById("footer-last-update");
          if (footerLastUpdate) {
            footerLastUpdate.textContent = dt.toLocaleString("pt-BR");
          }
        } else {
          document.getElementById("temp-display").textContent = "--";
          document.getElementById("humidity-display").textContent = "--";
          const footerLastUpdate =
            document.getElementById("footer-last-update");
          if (footerLastUpdate) {
            footerLastUpdate.textContent = "--";
          }
        }
        // === Atualiza inputs de parÃ¢metros ===
        const minInput = document.getElementById("min-temp");
        const maxInput = document.getElementById("max-temp");

        if (minInput && data.min_temperature !== undefined) {
          minInput.value = data.min_temperature;
        }

        if (maxInput && data.max_temperature !== undefined) {
          maxInput.value = data.max_temperature;
        }

        // atualizaÃ§Ã£o do cartÃ£o de seguranÃ§a
        if (data.esp_ip)
          document.getElementById("safety-esp-ip").textContent =
            "IP do ESP: " + data.esp_ip;
        document.getElementById("safety-last-contact").textContent =
          "Ãšltimo contato: " +
          (data.last_contact_seconds !== null &&
          data.last_contact_seconds !== undefined
            ? data.last_contact_seconds + "s atrÃ¡s"
            : "--");

        const safetyCard = document.getElementById("safety-card");
        const safetyIcon = document.getElementById("safety-icon");
        const safetyText = document.getElementById("safety-status-text");
        safetyCard.classList.remove("open", "closed", "paused");

        if (!data.esp_online) {
          safetyText.textContent = "ESP Offline";
          safetyIcon.className = "bi bi-wifi-off fs-1 text-danger";
          safetyCard.classList.add("closed");
        } else if (data.fail_safe) {
          safetyText.textContent = "Fail-safe Ativo";
          safetyIcon.className = "bi bi-shield-exclamation fs-1 text-warning";
          safetyCard.classList.add("paused");
        } else {
          safetyText.textContent = "Conectado";
          safetyIcon.className = "bi bi-shield-check fs-1 text-success";
          safetyCard.classList.add("open");
        }

        // Se ESP offline, exibe offline nas duas cortinas e encerra (botÃµes jÃ¡ desativados)
        if (!data.esp_online) {
          // left
          document.getElementById("left-status-text").textContent = "Offline";
          document.getElementById("left-icon").className =
            "bi bi-wifi-off fs-1 text-danger";
          document.getElementById("left-movement-text").textContent = "";

          // right
          document.getElementById("right-status-text").textContent = "Offline";
          document.getElementById("right-icon").className =
            "bi bi-wifi-off fs-1 text-danger";
          document.getElementById("right-movement-text").textContent = "";

          disableManualButtons(true);
          return;
        }

        // --- LEFT card ---
        const leftOpen = Boolean(data.left_is_open);
        const leftAction = data.left || "stop";
        const leftCard = document.getElementById("left-card");
        const leftIcon = document.getElementById("left-icon");
        const leftStatusText = document.getElementById("left-status-text");
        const leftMovementText = document.getElementById("left-movement-text");
        leftCard.classList.remove("open", "closed", "paused");
        if (leftOpen) {
          leftStatusText.textContent = "Aberta";
          leftIcon.className = "bi bi-unlock-fill fs-1 text-umidade";
          leftCard.classList.add("open");
        } else {
          leftStatusText.textContent = "Fechada";
          leftIcon.className = "bi bi-lock-fill fs-1 text-aviso";
          leftCard.classList.add("closed");
        }
        if (leftAction === "open")
          leftMovementText.textContent = "Movimento: Abrindo ðŸ”¼";
        else if (leftAction === "close")
          leftMovementText.textContent = "Movimento: Fechando ðŸ”½";
        else leftMovementText.textContent = "Movimento: Parada â¸ï¸";
        if (leftAction !== "stop") leftCard.classList.add("paused");

        // --- RIGHT card ---
        const rightOpen = Boolean(data.right_is_open);
        const rightAction = data.right || "stop";
        const rightCard = document.getElementById("right-card");
        const rightIcon = document.getElementById("right-icon");
        const rightStatusText = document.getElementById("right-status-text");
        const rightMovementText = document.getElementById(
          "right-movement-text"
        );
        rightCard.classList.remove("open", "closed", "paused");
        if (rightOpen) {
          rightStatusText.textContent = "Aberta";
          rightIcon.className = "bi bi-unlock-fill fs-1 text-umidade";
          rightCard.classList.add("open");
        } else {
          rightStatusText.textContent = "Fechada";
          rightIcon.className = "bi bi-lock-fill fs-1 text-aviso";
          rightCard.classList.add("closed");
        }
        if (rightAction === "open")
          rightMovementText.textContent = "Movimento: Abrindo ðŸ”¼";
        else if (rightAction === "close")
          rightMovementText.textContent = "Movimento: Fechando ðŸ”½";
        else rightMovementText.textContent = "Movimento: Parada â¸ï¸";
        if (rightAction !== "stop") rightCard.classList.add("paused");

        // atualiza enable/disable dos botÃµes conforme modo automÃ¡tico
        updateInterfaceStateFromData(data);
      })
      .catch((err) => {
        console.error("Erro ao buscar status:", err);
      });
  }

  // ===== envio do form de parÃ¢metros =====
  document
    .getElementById("params-form")
    .addEventListener("submit", function (e) {
      e.preventDefault();
      const minTemp = parseFloat(document.getElementById("min-temp").value);
      const maxTemp = parseFloat(document.getElementById("max-temp").value);

      fetch("{% url 'set_parameters_api' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrfToken,
        },
        body: JSON.stringify({
          min_temperature: minTemp,
          max_temperature: maxTemp,
        }),
      })
        .then((r) => r.json())
        .then((data) => {
          showToast(
            data.success ? "ParÃ¢metros salvos!" : "Erro ao salvar",
            data.success ? "success" : "danger"
          );
          updateStatus();
        });
    });

  // ===== toggle automatic mode =====
  function toggleAutomaticMode(isAutomatic) {
    fetch("{% url 'toggle_automatic_mode' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": csrfToken,
      },
      body: JSON.stringify({ automatic_mode: isAutomatic }),
    })
      .then((r) => r.json())
      .then((data) => {
        showToast(
          data.automatic_mode
            ? "Modo automÃ¡tico ativado"
            : "Modo manual ativado",
          "success"
        );
        updateStatus();
      })
      .catch(() => showToast("Erro ao alternar modo", "danger"));
  }

  // ===== controles manuais left/right =====
  function manualLeft(action) {
    fetch("{% url 'manual_left_api' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": csrfToken,
      },
      body: JSON.stringify({ action: action }),
    })
      .then((r) => r.json())
      .then((data) => {
        showToast(
          data.success
            ? "Cortina Esquerda: aÃ§Ã£o realizada!"
            : data.message || "Erro",
          data.success ? "success" : "danger"
        );
        updateStatus();
      });
  }

  function manualRight(action) {
    fetch("{% url 'manual_right_api' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": csrfToken,
      },
      body: JSON.stringify({ action: action }),
    })
      .then((r) => r.json())
      .then((data) => {
        showToast(
          data.success
            ? "Cortina Direita: aÃ§Ã£o realizada!"
            : data.message || "Erro",
          data.success ? "success" : "danger"
        );
        updateStatus();
      });
  }

  function showToast(message, type = "success") {
    const toastContainer = document.getElementById("toast-container");
    const toastEl = document.createElement("div");
    toastEl.className = `toast align-items-center text-bg-${type} border-0`;
    toastEl.setAttribute("role", "alert");
    toastEl.setAttribute("aria-live", "assertive");
    toastEl.setAttribute("aria-atomic", "true");
    toastEl.innerHTML = `<div class="d-flex">
      <div class="toast-body">${message}</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>`;
    toastContainer.appendChild(toastEl);
    const toast = new bootstrap.Toast(toastEl);
    toast.show();
  }

  // Inicializa
  document.addEventListener("DOMContentLoaded", () => {
    updateStatus();
    setInterval(updateStatus, 5000);
  });
</script>
{% endblock %}
