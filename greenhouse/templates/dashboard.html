{% extends 'base.html' %} {% block content %}
<div class="row g-4">
  <div class="col-lg-8">
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-white border-0 d-flex align-items-center">
        <h4 class="mb-0">
          <i class="bi bi-speedometer2 me-2"></i>Status Atual
        </h4>
      </div>

      <div class="card-body">
        <div class="row text-center">
          <div class="col-md-4 mb-3">
            <div class="p-3">
              <i class="bi bi-thermometer-sun fs-1 text-temperatura"></i>
              <h2 class="mt-2 fw-semibold text-dark">
                <span id="temp-display">--</span>¬∞C
              </h2>
              <p class="text-muted mb-0">Temperatura</p>
            </div>
          </div>

          <div class="col-md-4 mb-3">
            <div class="p-3">
              <i class="bi bi-droplet-half fs-1 text-umidade"></i>
              <h2 class="mt-2 fw-semibold text-dark">
                <span id="humidity-display">--</span>%
              </h2>
              <p class="text-muted mb-0">Umidade</p>
            </div>
          </div>

          <div class="col-md-4 mb-3">
            <div class="p-3 status-card rounded-3" id="curtain-status-card">
              <i id="curtain-icon" class="fs-1 text-aviso"></i>
              <h4 class="mt-2 fw-semibold" id="curtain-status-text">--</h4>
              <p
                id="curtain-movement-text"
                class="text-secondary mt-1"
                style="font-size: 0.9rem"
              >
                --
              </p>

              <p class="text-muted mb-0">Status da Cortina</p>
            </div>
          </div>
        </div>

        <div class="text-center text-muted mt-3">
          <small>√öltima atualiza√ß√£o: <span id="last-update"></span></small>
        </div>

        <div class="mt-4 text-center">
          <a href="/historico" class="botao-historico">
            <i class="bi bi-bar-chart-fill me-2"></i> Ver hist√≥rico
          </a>

          <style>
            /* === PALETA DE CORES === */
            :root {
              --cor-primaria: #4caf50; /* Verde principal */
              --cor-primaria-hover: #45a049; /* Verde mais escuro para hover */
              --cor-aviso: #f7b500; /* Amarelo/Laranja para bot√µes de a√ß√£o */
              --cor-temperatura: #e53935; /* Vermelho para √≠cone de temperatura */
              --cor-umidade: #1e88e5; /* Azul para √≠cone de umidade */

              --cor-fundo: #f5f7f5;
              --cor-fundo-card: #ffffff;
              --cor-fundo-aberto: #e6f7ee; /* Fundo do card de status "Aberta" */
              --cor-fundo-fechado: #fff7e6; /* Fundo do card de status "Fechada" */
              --cor-borda: #e0e0e0;
            }
            /* ======================================= */
            /* === √çCONES COM CORES DA PALETA === */
            .text-temperatura {
              color: var(--cor-temperatura) !important;
            }
            .text-umidade {
              color: var(--cor-umidade) !important;
            }
            .text-aviso {
              color: var(--cor-aviso) !important;
            }

            /* === CARDS === */
            .card {
              border: none !important;
              border-radius: 20px !important;
              box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
              transition: transform 0.2s ease, box-shadow 0.2s ease;
            }

            .card:hover {
              transform: translateY(-3px);
              box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
            }

            .card-header {
              border-bottom: 2px solid var(--cor-primaria) !important;
              border-radius: 20px 20px 0 0 !important;
              background: var(--cor-fundo-card) !important;
              padding: 1rem 1.5rem;
            }

            .card-header h4,
            .card-header h5 {
              color: var(--cor-primaria);
              font-weight: 600;
              margin: 0;
            }

            /* === STATUS CARDS (temperatura, umidade, cortina) === */
            .status-card {
              background: #f8fdf8;
              border-radius: 15px;
              padding: 1rem;
              transition: background 0.3s;
            }

            .status-card.open {
              background: var(--cor-fundo-aberto);
            }

            .status-card.closed {
              background: var(--cor-fundo-fechado);
            }

            /* === BOT√ïES === */
            .btn-success,
            .btn-primary,
            .btn-warning {
              border: none;
              border-radius: 10px !important;
              font-weight: 600;
            }
            .btn-primary {
              background-color: var(--cor-primaria) !important;
            }

            .btn-primary:hover {
              background-color: var(--cor-primaria-hover) !important;
            }

            .btn-warning {
              background-color: var(--cor-aviso) !important;
            }

            /* ===FORMUL√ÅRIOS === */
            .form-control {
              border-radius: 12px !important;
              border: 1px solid var(--cor-borda) !important;
              padding: 0.8rem 1rem;
              transition: border-color 0.2s, box-shadow 0.2s;
            }

            .form-control:focus {
              border-color: var(--cor-primaria) !important;
              box-shadow: 0 0 0 0.15rem rgba(75, 145, 42, 0.25) !important;
            }

            /* === SWITCH === */
            .form-check-input:checked {
              background-color: var(--cor-primaria) !important;
              border-color: var(--cor-primaria) !important;
            }

            /* === HIST√ìRICO === */
            .botao-historico {
              display: inline-flex;
              justify-content: center;
              align-items: center;
              gap: 0.6rem;
              background-color: var(--cor-primaria);
              color: white !important;
              font-weight: 600;
              padding: 0.6rem 1.2rem;
              font-size: 0.95rem;
              border-radius: 12px;
              text-decoration: none;
              box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
              transition: all 0.2s ease;
              margin: 0 auto;
              display: block;
              width: fit-content;
            }

            .botao-historico:hover {
              background-color: var(--cor-primaria-hover);
              transform: translateY(-2px);
              box-shadow: 0 6px 12px rgba(0, 0, 0, 0.25);
            }

            /* === T√çTULOS GERAIS === */
            h4,
            h5 {
              font-weight: 600;
            }

            /* === TEXTO DE STATUS === */
            .text-muted {
              font-size: 0.9rem;
            }

            /* === √çCONES GRANDES === */
            .fs-1 {
              font-size: 2.5rem !important;
            }
            /* Corrige bordas dos bot√µes dentro do grupo */
            .btn-group .btn {
              border-radius: 12px !important; /* deixa todos arredondados */
              margin: 0 1px; /* d√° um pequeno espa√ßamento entre eles */
            }

            /* Remove a fus√£o de bordas padr√£o do Bootstrap */
            .btn-group {
              gap: 0 !important;
            }
            .status-card.paused {
              background: #fffbe6; /* amarelo clarinho */
              animation: blink 1.5s infinite alternate;
            }

            @keyframes blink {
              from {
                box-shadow: 0 0 0px rgba(255, 193, 7, 0.4);
              }
              to {
                box-shadow: 0 0 12px rgba(255, 193, 7, 0.8);
              }
            }
          </style>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-white">
        <h5 class="mb-0">Definir Par√¢metros</h5>
      </div>
      <div class="card-body">
        <form id="params-form">
          {% csrf_token %}
          <label for="min-temp" class="form-label"
            >Temperatura M√≠nima (¬∞C)</label
          >
          <input
            type="number"
            step="0.5"
            class="form-control mb-2"
            id="min-temp"
            value="{{ control.min_temperature }}"
          />

          <label for="max-temp" class="form-label"
            >Temperatura M√°xima (¬∞C)</label
          >
          <div class="input-group mb-3">
            <input
              type="number"
              step="0.5"
              class="form-control"
              id="max-temp"
              value="{{ control.max_temperature }}"
            />
            <button class="btn btn-outline-success" type="submit">
              Salvar
            </button>
          </div>
        </form>
      </div>
    </div>
    <div class="form-check form-switch text-start mb-3">
      <input
        class="form-check-input"
        type="checkbox"
        id="auto-switch"
        {%
        if
        control.automatic_mode
        %}checked{%
        endif
        %}
        onchange="toggleAutomaticMode(this.checked)"
      />
      <label class="form-check-label" for="autoModeSwitch">
        Modo Autom√°tico
      </label>
    </div>

    <div class="card shadow-sm">
      <div class="card-header bg-white">
        <h5 class="mb-0">Controle Manual</h5>
      </div>
      <div class="card-body text-center">
        <div class="btn-group w-100">
          <button
            id="btn-open"
            class="btn btn-success btn-lg"
            onclick="manualControl('open')"
          >
            <i class="bi bi-arrow-up-circle"></i> Abrir
          </button>

          <button
            id="btn-stop"
            class="btn btn-warning btn-lg"
            onclick="manualControl('stop')"
          >
            <i class="bi bi-pause-circle"></i> Parar
          </button>

          <button
            id="btn-close"
            class="btn btn-danger btn-lg"
            onclick="manualControl('close')"
          >
            <i class="bi bi-arrow-down-circle"></i> Fechar
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<div
  id="toast-container"
  class="toast-container position-fixed bottom-0 end-0 p-3"
></div>
{% endblock %} {% block scripts %}
<script>
  const csrfToken = document.querySelector("[name=csrfmiddlewaretoken]").value;

  function updateStatus() {
    fetch("{% url 'api_status' %}?device=browser")
      .then((response) => response.json())
      .then((data) => {
        if (data.latest_reading) {
          document.getElementById("temp-display").textContent =
            data.latest_reading.temperature.toFixed(1);

          document.getElementById("humidity-display").textContent =
            data.latest_reading.humidity.toFixed(1);

          const dt = new Date(data.latest_reading.timestamp);
          document.getElementById("last-update").textContent =
            dt.toLocaleString("pt-BR");
        } else {
          document.getElementById("temp-display").textContent = "--";
          document.getElementById("humidity-display").textContent = "--";
          document.getElementById("last-update").textContent = "--";
        }
        // --- ESP OFFLINE ---
        if (!data.esp_online) {
          document.getElementById("curtain-status-text").textContent =
            "ESP Offline";
          document.getElementById("curtain-icon").className =
            "bi bi-wifi-off fs-1 text-danger";

          // Desativa bot√µes
          document.getElementById("btn-open").disabled = true;
          document.getElementById("btn-close").disabled = true;
          document.getElementById("btn-stop").disabled = true;

          showToast("ESP32 est√° offline ‚Äî comandos desativados!", "danger");
          return;
        }

        // --- ESP Online ---
        const statusCard = document.getElementById("curtain-status-card");
        const statusText = document.getElementById("curtain-status-text");
        const statusIcon = document.getElementById("curtain-icon");

        // POSI√á√ÉO REAL (aberto / fechado)
        const isOpen = data.curtain_is_open;

        // MOVIMENTO (abrindo / fechando / parado)
        const movement = data.curtain_status;
        const movementText = document.getElementById("curtain-movement-text");

        if (movement === "open") {
          movementText.textContent = "Movimento: Abrindo üîº";
        } else if (movement === "close") {
          movementText.textContent = "Movimento: Fechando üîΩ";
        } else if (movement === "stop") {
          movementText.textContent = "Movimento: Parada ‚è∏Ô∏è";
        } else {
          movementText.textContent = "Movimento: --";
        }

        // Reset classes
        statusCard.classList.remove("open", "closed", "paused");

        // --- EXIBE A POSI√á√ÉO REAL ---
        if (isOpen) {
          statusText.textContent = "Aberta";
          statusIcon.className = "bi bi-unlock-fill fs-1 text-umidade";
          statusCard.classList.add("open");
        } else {
          statusText.textContent = "Fechada";
          statusIcon.className = "bi bi-lock-fill fs-1 text-aviso";
          statusCard.classList.add("closed");
        }

        // --- EST√âTICA DE MOVIMENTO--
        if (movement !== "stop") {
          statusCard.classList.add("paused");
        }

        // reabilita bot√µes se n√£o estiver no autom√°tico
        let isAuto = data.automatic_mode;
        document.getElementById("btn-open").disabled = isAuto;
        document.getElementById("btn-close").disabled = isAuto;
        document.getElementById("btn-stop").disabled = isAuto;
      });
  }

  document
    .getElementById("params-form")
    .addEventListener("submit", function (e) {
      e.preventDefault();
      const minTemp = parseFloat(document.getElementById("min-temp").value);
      const maxTemp = parseFloat(document.getElementById("max-temp").value);

      fetch("{% url 'api_set_parameters' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrfToken,
        },
        body: JSON.stringify({
          min_temperature: minTemp,
          max_temperature: maxTemp,
        }),
      })
        .then((response) => response.json())
        .then((data) => {
          showToast(
            data.success ? "Par√¢metros salvos!" : "Erro ao salvar",
            data.success ? "success" : "danger"
          );
          updateStatus(); // Atualiza o dashboard imediatamente
          updateManualButtonsState();
        });
    });

  function toggleAutomaticMode(isAutomatic) {
    fetch("{% url 'toggle_automatic_mode' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": csrfToken,
      },
      body: JSON.stringify({ automatic_mode: isAutomatic }),
    })
      .then((response) => response.json())
      .then((data) => {
        showToast(
          data.automatic_mode
            ? "Modo autom√°tico ativado"
            : "Modo manual ativado",
          "success"
        );
        updateInterfaceState();
      })
      .catch(() => showToast("Erro ao alternar o modo", "danger"));
  }

  // Atualiza os estados dos bot√µes e campos de par√¢metros
  function updateInterfaceState() {
    const isAuto = document.getElementById("auto-switch").checked;

    // Bot√µes de controle manual ficam desativados no modo autom√°tico
    document.getElementById("btn-open").disabled = isAuto;
    document.getElementById("btn-close").disabled = isAuto;
    document.getElementById("btn-stop").disabled = isAuto;

    // Campos de par√¢metros ficam desativados no modo manual
    document.getElementById("min-temp").disabled = !isAuto;
    document.getElementById("max-temp").disabled = !isAuto;
    document.querySelector("#params-form button").disabled = !isAuto;
  }

  // Atualiza o estado inicial ao carregar a p√°gina
  document.addEventListener("DOMContentLoaded", () => {
    fetch("{% url 'api_status' %}?device=browser")
      .then((res) => res.json())
      .then((data) => {
        const autoSwitch = document.getElementById("auto-switch");
        autoSwitch.checked = data.automatic_mode; // garante que checkbox reflete o banco
        updateInterfaceState(); // atualiza bot√µes e campos
      })
      .catch((err) => console.error("Erro ao buscar estado autom√°tico:", err));
  });

  function updateManualButtonsState() {
    const isAuto = document.getElementById("auto-switch").checked;
    document.getElementById("btn-open").disabled = isAuto;
    document.getElementById("btn-close").disabled = isAuto;
  }

  function manualControl(action) {
    fetch("{% url 'api_manual_control' %}", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": csrfToken,
      },
      body: JSON.stringify({ action: action }),
    })
      .then((response) => response.json())
      .then((data) => {
        showToast(
          data.success ? "A√ß√£o realizada!" : "Erro na a√ß√£o",
          data.success ? "success" : "danger"
        );
        updateStatus(); // Atualiza o dashboard imediatamente
      });
  }

  function showToast(message, type = "success") {
    const toastContainer = document.getElementById("toast-container");
    const toastEl = document.createElement("div");
    toastEl.className = `toast align-items-center text-bg-${type} border-0`;
    toastEl.setAttribute("role", "alert");
    toastEl.setAttribute("aria-live", "assertive");
    toastEl.setAttribute("aria-atomic", "true");
    toastEl.innerHTML = `
      <div class="d-flex">
        <div class="toast-body">${message}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    `;
    toastContainer.appendChild(toastEl);
    const toast = new bootstrap.Toast(toastEl);
    toast.show();
  }

  // Atualiza√ß√£o autom√°tica a cada 5 segundos
  updateStatus();
  setInterval(updateStatus, 5000);
</script>
{% endblock %}
