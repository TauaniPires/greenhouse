{% extends 'base.html' %} {% block content %}

<style>
  :root {
    --cor-primaria: #4caf50;
    --cor-primaria-hover: #45a049;
    --cor-aviso: #f7b500;
    --cor-temperatura: #e53935;
    --cor-umidade: #1e88e5;
    --cor-borda: #e0e0e0;
  }

  html,
  body {
    height: auto;
    overflow-y: auto;
    background-color: #f5f7f5;
  }

  .title-container {
    position: relative;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    margin-top: 15px;
    margin-bottom: 15px;
  }

  .title-container h2 {
    flex: 1;
    text-align: center;
    font-size: 1.7rem;
    color: #333;
    font-weight: 600;
    margin: 0;
  }

  .btn-voltar {
    color: var(--cor-primaria);
    font-weight: 600;
    font-size: 1rem;
    text-decoration: none;
    transition: color 0.2s ease;
  }

  .btn-voltar:hover {
    color: var(--cor-primaria-hover);
    text-decoration: underline;
  }

  .filter-bar {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
    margin-bottom: 20px;
  }

  .filter-bar input[type="date"] {
    padding: 0.4rem 0.7rem;
    font-size: 0.9rem;
    border-radius: 10px !important;
    border: 1px solid var(--cor-borda) !important;
    background-color: #f8f9fa;
    max-width: 160px;
  }

  .filter-bar button {
    background-color: var(--cor-primaria);
    color: white;
    padding: 0.4rem 1rem;
    border-radius: 8px;
    border: none;
    font-weight: 600;
  }

  .chart-container {
    position: relative;
    width: 100%;
    height: 350px;
    margin: 0 auto;
  }

  .table {
    font-size: 0.9rem;
  }

  .table thead th {
    background-color: var(--cor-primaria);
    color: white;
  }

  @media (max-width: 600px) {
    .btn-voltar {
      width: 100%;
      text-align: left;
    }
    .filter-bar {
      flex-direction: column;
      width: 100%;
    }
    .filter-bar input[type="date"],
    .filter-bar button {
      width: 80%;
      max-width: 300px;
    }
  }
</style>

<div class="title-container">
  <a href="{% url 'dashboard' %}" class="btn-voltar">
    <i class="bi bi-arrow-left"></i> Voltar
  </a>
  <h2>Histórico de Temperatura e Umidade</h2>
</div>

<form method="get" action="{% url 'historico' %}" class="filter-bar">
  <label for="startDate">Data Inicial:</label>
  <input type="date" id="startDate" name="start" value="{{ start_date }}" />

  <label for="endDate">Data Final:</label>
  <input type="date" id="endDate" name="end" value="{{ end_date }}" />

  <button type="submit">Filtrar</button>
</form>

<div class="chart-container">
  <canvas id="historicoChart"></canvas>
</div>

<hr class="my-5" />

<h2 class="text-center mt-5">Histórico de Ações da Cortina</h2>

<div class="table-responsive mt-3 mb-5">
  <table class="table table-striped table-bordered text-center align-middle">
    <thead class="table-success">
      <tr>
        <th>Data e Hora</th>
        <th>Status</th>
        <th>Lado</th>
        <th>Modo</th>
        <th>Temperatura (°C)</th>
        <th>Umidade (%)</th>
        <th>Usuário</th>
      </tr>
    </thead>
    <tbody>
      {% for log in logs %}
      <tr>
        <td>{{ log.timestamp|date:"d/m/Y H:i:s" }}</td>

        <!-- STATUS -->
        <td>
          {% if log.status == "Fechada" %}
          <span class="text-danger fw-semibold">Fechada</span>
          {% else %}
          <span class="text-success fw-semibold">Aberta</span>
          {% endif %}
        </td>

        <!-- LADO -->
        <td>{{ log.lado|title }}</td>

        <!-- MODO -->
        <td>
          {% if log.modo == "modo automático" %} Automático {% else %} Manual
          {%endif %}
        </td>

        <td>{{ log.temperature|floatformat:1 }}</td>
        <td>{{ log.humidity|floatformat:1 }}</td>
        <td>{{ log.usuario }}</td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="7">Nenhum registro encontrado.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const leituras = JSON.parse("{{ leituras_json|escapejs }}");

  const labels = leituras.map((l) => {
    const date = new Date(l.timestamp);

    const dia = date.toLocaleDateString("pt-BR", {
      day: "2-digit",
      month: "2-digit",
    });

    const hora = date.toLocaleTimeString([], {
      hour: "2-digit",
      minute: "2-digit",
    });

    // Array = rótulo em duas linhas (dia em cima, hora embaixo)
    return [dia, hora];
  });

  const temperaturas = leituras.map((l) => l.temperature);
  const humidades = leituras.map((l) => l.humidity);

  const ctx = document.getElementById("historicoChart");

  new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [
        {
          label: "Temperatura média por hora (°C)",
          data: temperaturas,
          borderColor: "rgba(229, 57, 53, 1)",
          backgroundColor: "rgba(229, 57, 53, 0.15)",
          yAxisID: "y1",
          tension: 0.5,
          cubicInterpolationMode: "monotone",
          borderWidth: 3,
          pointRadius: 4,
          pointHoverRadius: 6,
        },
        {
          label: "Umidade média por hora (%)",
          data: humidades,
          borderColor: "rgba(30, 136, 229, 1)",
          backgroundColor: "rgba(30, 136, 229, 0.15)",
          yAxisID: "y2",
          tension: 0.5,
          cubicInterpolationMode: "monotone",
          borderWidth: 3,
          pointRadius: 4,
          pointHoverRadius: 6,
        },
      ],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: "index", intersect: false },
      scales: {
        y1: {
          type: "linear",
          position: "left",
          title: { display: true, text: "Temperatura (°C)" },
        },
        y2: {
          type: "linear",
          position: "right",
          title: { display: true, text: "Umidade (%)" },
          grid: { drawOnChartArea: false },
        },
      },
    },
  });
</script>

{% endblock %}
