{% extends 'base.html' %} {% block content %}
<style>
  :root {
    --cor-primaria: #4caf50;
    --cor-primaria-hover: #45a049;
    --cor-aviso: #f7b500;
    --cor-temperatura: #e53935;
    --cor-umidade: #1e88e5;
    --cor-borda: #e0e0e0;
  }
  .title-container {
    position: relative;
    display: flex;
    justify-content: center;
    align-items: center;
    margin-top: 20px;
    margin-bottom: 20px;
    width: 100%;
  }
  .back-arrow {
    position: absolute;
    left: 20px;
    font-size: 2.5rem;
    color: var(--cor-primaria);
    font-weight: bold;
    text-decoration: none;
    transition: color 0.2s;
  }
  .back-arrow:hover {
    color: var(--cor-primaria-hover);
  }
  h2 {
    margin: 5px 0;
    font-size: 1.8rem;
    color: #333;
    text-align: center;
  }

  .filter-bar {
    display: flex;
    justify-content: center;
    align-items: center;
    flex-wrap: wrap;
    gap: 15px; /* Mais espaço */
    margin-bottom: 25px;
  }
  .filter-bar label {
    font-weight: 600;
    margin-right: 5px;
    font-size: 1rem;
  }

  .filter-bar input[type="date"] {
    padding: 0.6rem 1rem;
    font-size: 1rem;
    border-radius: 12px !important;
    border: 1px solid var(--cor-borda) !important;
    background-color: #f8f9fa;
    cursor: pointer;
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  .filter-bar input[type="date"]:focus {
    border-color: var(--cor-primaria) !important;
    box-shadow: 0 0 0 0.15rem rgba(75, 145, 42, 0.25) !important;
  }

  .filter-bar button {
    background-color: var(--cor-primaria) !important;
    border: none;
    border-radius: 10px !important;
    font-weight: 600;
    color: white;
    padding: 0.6rem 1rem;
    transition: background-color 0.2s;
  }
  .filter-bar button:hover {
    background-color: var(--cor-primaria-hover) !important;
  }

  .chart-container {
    position: relative;
    width: 100%;
    max-width: 100%;
    height: 300px;
    margin: 0 auto;
  }
  @media (min-width: 768px) {
    .chart-container {
      height: 400px;
    }
  }

  @media (max-width: 600px) {
    .filter-bar {
      flex-direction: column;
      align-items: stretch;
    }
    .title-container {
      flex-direction: column;
      align-items: center;
      margin-top: 10px;
    }
    .back-arrow {
      position: static;
      margin-bottom: 10px;
      font-size: 36px;
      text-align: center;
    }
    h2 {
      font-size: 1.5rem;
      text-align: center;
    }
    .filter-bar label,
    .filter-bar input,
    .filter-bar button {
      width: 100%;
      font-size: 14px;
      text-align: center;
    }
    .filter-bar label {
      text-align: left;
      margin-bottom: -10px;
    }
  }
</style>

<div class="title-container">
  <a href="{% url 'dashboard' %}" class="back-arrow">←</a>
  <h2>Histórico de Temperatura e Umidade</h2>
</div>

<div class="filter-bar">
  <label for="startDate">Data Inicial:</label>
  <input type="date" id="startDate" value="{{ start_date }}" />
  <label for="endDate">Data Final:</label>
  <input type="date" id="endDate" value="{{ end_date }}" />

  <button id="filterBtn">Filtrar</button>
</div>

<div class="chart-container">
  <canvas id="historicoChart"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const leituras = JSON.parse("{{ leituras_json|escapejs }}");

  const labels = leituras.map((l) => {
    const date = new Date(l.timestamp);
    return (
      date.toLocaleDateString([], { day: "2-digit", month: "2-digit" }) +
      " " +
      date.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })
    );
  });
  const temperaturas = leituras.map((l) => l.temperature);
  const humidades = leituras.map((l) => l.humidity);

  const corTemperatura = "rgba(229, 57, 53, 1)";
  const corTemperaturaBg = "rgba(229, 57, 53, 0.2)";
  const corUmidade = "rgba(30, 136, 229, 1)";
  const corUmidadeBg = "rgba(30, 136, 229, 0.2)";

  const ctx = document.getElementById("historicoChart").getContext("2d");
  const historicoChart = new Chart(ctx, {
    type: "line",
    data: {
      labels: labels,
      datasets: [
        {
          label: "Temperatura (°C)",
          data: temperaturas,
          borderColor: corTemperatura,
          backgroundColor: corTemperaturaBg,
          yAxisID: "y1",
          tension: 0.3,
        },
        {
          label: "Umidade (%)",
          data: humidades,
          borderColor: corUmidade,
          backgroundColor: corUmidadeBg,
          yAxisID: "y2",
          tension: 0.3,
        },
      ],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: "index", intersect: false },
      stacked: false,
      scales: {
        y1: {
          type: "linear",
          display: true,
          position: "left",
          title: { display: true, text: "Temperatura (°C)" },
        },
        y2: {
          type: "linear",
          display: true,
          position: "right",
          title: { display: true, text: "Umidade (%)" },
          grid: { drawOnChartArea: false },
        },
        x: {
          ticks: {
            maxRotation: 45,
            minRotation: 0,
            autoSkip: true,
            maxTicksLimit: 10,
          },
        },
      },
    },
  });

  // Filtro por datas
  document.getElementById("filterBtn").addEventListener("click", () => {
    const start = document.getElementById("startDate").value;
    const end = document.getElementById("endDate").value;
    let url = `/historico/`;
    if (start) url += `?start=${start}`;
    if (end) url += start ? `&end=${end}` : `?end=${end}`;
    window.location.href = url;
  });
</script>
{% endblock %}
