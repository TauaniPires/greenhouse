{% extends 'base.html' %} {% block content %}
<style>
  :root {
    --cor-primaria: #4caf50;
    --cor-primaria-hover: #45a049;
    --cor-aviso: #f7b500;
    --cor-temperatura: #e53935;
    --cor-umidade: #1e88e5;
    --cor-borda: #e0e0e0;
  }

  /* garante que a página role normalmente */
  html,
  body {
    height: auto;
    overflow-y: auto;
    background-color: #f5f7f5;
  }

  /* ===== TÍTULO E BOTÃO VOLTAR ===== */
  .title-container {
    position: relative;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    margin-top: 15px;
    margin-bottom: 15px;
  }

  .title-container h2 {
    flex: 1;
    text-align: center;
    font-size: 1.7rem;
    color: #333;
    font-weight: 600;
    margin: 0;
  }

  .btn-voltar {
    color: var(--cor-primaria);
    font-weight: 600;
    font-size: 1rem;
    text-decoration: none;
    transition: color 0.2s ease;
  }

  .btn-voltar:hover {
    color: var(--cor-primaria-hover);
    text-decoration: underline;
  }

  /* ===== FILTROS ===== */
  .filter-bar {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
    margin-bottom: 20px;
    text-align: center;
  }

  .filter-bar label {
    font-weight: 600;
    font-size: 0.9rem;
  }

  .filter-bar input[type="date"] {
    padding: 0.4rem 0.7rem;
    font-size: 0.9rem;
    border-radius: 10px !important;
    border: 1px solid var(--cor-borda) !important;
    background-color: #f8f9fa;
    cursor: pointer;
    max-width: 160px;
  }

  .filter-bar input[type="date"]:focus {
    border-color: var(--cor-primaria) !important;
    box-shadow: 0 0 0 0.1rem rgba(75, 145, 42, 0.25) !important;
  }

  .filter-bar button {
    background-color: var(--cor-primaria) !important;
    border: none;
    border-radius: 8px !important;
    font-weight: 600;
    color: white;
    padding: 0.4rem 1rem;
    font-size: 0.9rem;
    transition: background-color 0.2s;
  }

  .filter-bar button:hover {
    background-color: var(--cor-primaria-hover) !important;
  }

  /* ===== GRÁFICO ===== */
  .chart-container {
    position: relative;
    width: 100%;
    max-width: 100%;
    height: 350px;
    margin: 0 auto;
  }

  /* ===== TABELA ===== */
  .table {
    font-size: 0.9rem;
  }

  .table thead th {
    background-color: var(--cor-primaria);
    color: white;
    border-color: #ddd;
  }

  .table td,
  .table th {
    vertical-align: middle;
  }

  /* ===== RESPONSIVO ===== */
  @media (max-width: 600px) {
    .btn-voltar {
      width: 100%;
      text-align: left;
    }

    .filter-bar {
      flex-direction: column;
      align-items: center; /* centraliza horizontalmente */
      justify-content: center;
      text-align: center;
      width: 100%;
    }

    .filter-bar label {
      width: auto;
      text-align: center;
      margin-bottom: -4px;
    }

    .filter-bar input[type="date"],
    .filter-bar button {
      width: 80%; /* deixa os inputs e o botão centralizados e mais estreitos */
      max-width: 300px;
      text-align: center;
    }
  }
</style>

<div class="title-container">
  <a href="{% url 'dashboard' %}" class="btn-voltar"
    ><i class="bi bi-arrow-left"></i> Voltar</a
  >
  <h2>Histórico de Temperatura e Umidade</h2>
</div>

<div class="filter-bar">
  <label for="startDate">Data Inicial:</label>
  <input type="date" id="startDate" value="{{ start_date }}" />
  <label for="endDate">Data Final:</label>
  <input type="date" id="endDate" value="{{ end_date }}" />

  <button id="filterBtn">Filtrar</button>
</div>

<div class="chart-container">
  <canvas id="historicoChart"></canvas>
</div>
<hr class="my-5" />

<h2 class="text-center mt-5">Histórico de Ações da Cortina</h2>

<div class="table-responsive mt-3 mb-5">
  <table class="table table-striped table-bordered text-center align-middle">
    <thead class="table-success">
      <tr>
        <th>Data e Hora</th>
        <th>Ação</th>
        <th>Temperatura (°C)</th>
        <th>Umidade (%)</th>
        <th>Usuário</th>
      </tr>
    </thead>
    <tbody>
      {% for log in logs %}
      <tr>
        <td>{{ log.timestamp|date:"d/m/Y H:i:s" }}</td>
        <td>
          {% if log.action == "open" %}
          <span class="text-success fw-semibold">Aberta</span>
          {% else %}
          <span class="text-warning fw-semibold">Fechada</span>
          {% endif %}
        </td>
        <td>{{ log.temperature|floatformat:1 }}</td>
        <td>{{ log.humidity|floatformat:1 }}</td>
        <td>{{ log.triggered_by.username|default:"Automático" }}</td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="5">Nenhum registro encontrado.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const leituras = JSON.parse("{{ leituras_json|escapejs }}");

  const labels = leituras.map((l) => {
    const date = new Date(l.timestamp);
    return (
      date.toLocaleDateString([], { day: "2-digit", month: "2-digit" }) +
      " " +
      date.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })
    );
  });
  const temperaturas = leituras.map((l) => l.temperature);
  const humidades = leituras.map((l) => l.humidity);

  const corTemperatura = "rgba(229, 57, 53, 1)";
  const corTemperaturaBg = "rgba(229, 57, 53, 0.2)";
  const corUmidade = "rgba(30, 136, 229, 1)";
  const corUmidadeBg = "rgba(30, 136, 229, 0.2)";

  const ctx = document.getElementById("historicoChart").getContext("2d");
  const historicoChart = new Chart(ctx, {
    type: "line",
    data: {
      labels: labels,
      datasets: [
        {
          label: "Temperatura (°C)",
          data: temperaturas,
          borderColor: corTemperatura,
          backgroundColor: corTemperaturaBg,
          yAxisID: "y1",
          tension: 0.3,
        },
        {
          label: "Umidade (%)",
          data: humidades,
          borderColor: corUmidade,
          backgroundColor: corUmidadeBg,
          yAxisID: "y2",
          tension: 0.3,
        },
      ],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: "index", intersect: false },
      stacked: false,
      scales: {
        y1: {
          type: "linear",
          display: true,
          position: "left",
          title: { display: true, text: "Temperatura (°C)" },
        },
        y2: {
          type: "linear",
          display: true,
          position: "right",
          title: { display: true, text: "Umidade (%)" },
          grid: { drawOnChartArea: false },
        },
        x: {
          ticks: {
            maxRotation: 45,
            minRotation: 0,
            autoSkip: true,
            maxTicksLimit: 10,
          },
        },
      },
    },
  });

  // Filtro por datas
  document.getElementById("filterBtn").addEventListener("click", () => {
    const start = document.getElementById("startDate").value;
    const end = document.getElementById("endDate").value;
    let url = `/historico/`;
    if (start) url += `?start=${start}`;
    if (end) url += start ? `&end=${end}` : `?end=${end}`;
    window.location.href = url;
  });
</script>
{% endblock %}
